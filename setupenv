
#export CLANG_PATH="${HOME}/Android/Sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin"
#export PATH=${CLANG_PATH}:${PATH}
#export CLANG_TRIPLE=aarch64-linux-gnu-
#export CROSS_COMPILE="${HOME}/Android/Sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-"
export ARCH=arm64
export CROSS_COMPILE=aarch64-linux-gnu-

export DEFCONFIG="vendor/sm8150-perf_defconfig"
export SMURF="${HOME}/1p7/smurf"

# Paths
export KERNEL_DIR="${SMURF}/stock"
export DIST_DIR="${SMURF}/dist"
export SMAKE="make O=${KERNEL_DIR}/out"

# Functions
function clean_all {
    cd $KERNEL_DIR
    echo
    $SMAKE distclean
    $SMAKE mrproper
}

function save_config {
    echo cd $KERNEL_DIR
    cd $KERNEL_DIR
    echo $SMAKE savedefconfig
    $SMAKE savedefconfig 
    echo cp out/defconfig arch/arm64/configs/$DEFCONFIG
    cp out/defconfig arch/arm64/configs/$DEFCONFIG 
    echo git add arch/arm64/configs/$DEFCONFIG
    git add arch/arm64/configs/$DEFCONFIG 
    echo "git commit -m\"defconfig change\""
    git commit -m"defconfig change" 
}

function make_kernel {
    cd $KERNEL_DIR
    echo $SMAKE $DEFCONFIG
    $SMAKE $DEFCONFIG
    $SMAKE nconfig 
    $SMAKE -j32

}



function package_all {
	 set -o errtrace
	 trap 'echo ERROR OCCURED; break' ERR
	 while true; do
	     magiskboot cpio $DIST_DIR/ramdisk.cpio "mkdir 755 /vendor/lib" "mkdir 755 /vendor/lib/modules"
	     for modf in `find $KERNEL_DIR -name "*.ko"`; do
	          cp -v $modf $DIST_DIR/modules
		  bname=`basename $modf`
		  echo $bname
		  magiskboot cpio $DIST_DIR/ramdisk.cpio "add 644 /vendor/lib/modules/${bname} ${DIST_DIR}/modules/${bname}"
	     done
	     cp -vr $KERNEL_DIR/out/arch/arm64/boot/Image-dtb $DIST_DIR/kernel
    	     magiskboot compress=gzip ${DIST_DIR}/ramdisk.cpio ${DIST_DIR}/bootable.gz
	     
	     break
    	done
	trap - ERR
	set +o errtrace
}


DATE_START=$(date +"%s")


# Vars





